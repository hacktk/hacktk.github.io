<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Docker で nginx を Graceful Shutdown させる | hacktk blog</title><link rel=icon href=https://hacktk.net/images/favicon.ico><link rel=canonical href=https://hacktk.net/shutdown-nginx-in-docker-gracefully/><link rel=alternate href=https://hacktk.net/index.xml type=application/rss+xml title="hacktk blog"><meta name=description content="Docker で nginx を動かしている場合、そのままでは Fast Shutdown になる。これを Gracefully にする方法。"><meta property="og:title" content="Docker で nginx を Graceful Shutdown させる"><meta property="og:description" content="Docker で nginx を動かしている場合、そのままでは Fast Shutdown になる。これを Gracefully にする方法。"><meta property="og:type" content="article"><meta property="og:url" content="https://hacktk.net/shutdown-nginx-in-docker-gracefully/"><meta property="og:image" content="https://hacktk.net/images/og.png"><meta property="article:published_time" content="2020-07-05T14:00:00+09:00"><meta property="article:modified_time" content="2020-07-05T14:00:00+09:00"><meta name=twitter:title content="Docker で nginx を Graceful Shutdown させる"><meta name=twitter:description content="Docker で nginx を動かしている場合、そのままでは Fast Shutdown になる。これを Gracefully にする方法。"><meta name=twitter:card content="summary"><meta name=twitter:image content="https://hacktk.net/images/og.png"><style>pre,textarea{overflow:auto}[hidden],audio:not([controls]),template{display:none}details,main,summary{display:block}input[type=number]{width:auto}input[type=search]{-webkit-appearance:textfield}input[type=search]::-webkit-search-cancel-button,input[type=search]::-webkit-search-decoration{-webkit-appearance:none}progress{display:inline-block}small{font-size:75%}textarea{resize:vertical}[unselectable]{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}*,::after,::before{box-sizing:inherit;border-style:solid;border-width:0}*{font-size:inherit;line-height:inherit;margin:0;padding:0}::after,::before{text-decoration:inherit;vertical-align:inherit}:root{-ms-overflow-style:-ms-autohiding-scrollbar;overflow-y:scroll;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%;text-size-adjust:100%;box-sizing:border-box;cursor:auto;text-rendering:optimizeLegibility}audio,canvas,iframe,img,svg,video{vertical-align:middle}button,input,select,textarea{background-color:transparent;color:inherit;font-family:inherit;font-style:inherit;font-weight:inherit;min-height:1.5em}code,kbd,pre,samp{font-family:monospace,monospace}nav ol,nav ul{list-style:none}select{-moz-appearance:none;-webkit-appearance:none}select::-ms-expand{display:none}select::-ms-value{color:currentColor}table{border-collapse:collapse;border-spacing:0}::-moz-selection{background-color:#b3d4fc;text-shadow:none}::selection{background-color:#b3d4fc;text-shadow:none}@media screen{[hidden~=screen]{display:inherit}[hidden~=screen]:not(:active):not(:focus):not(:target){clip:rect(0 0 0 0)!important;position:absolute!important}}*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;*behavior:url(/scripts/boxsizing.htc)}.container{max-width:800px;margin:0 auto}.container:after,.row:after,.col:after,.clr:after,.group:after{content:"";display:table;clear:both}.row{padding-bottom:0}.col{display:block;float:left;width:100%}@media(min-width:768px){.gutters .col{margin-left:2%}.gutters .col:first-child{margin-left:0}}@media(min-width:768px){.span_1{width:8.33333333333%}.span_2{width:16.6666666667%}.span_3{width:25%}.span_4{width:33.3333333333%}.span_5{width:41.6666666667%}.span_6{width:50%}.span_7{width:58.3333333333%}.span_8{width:66.6666666667%}.span_9{width:75%}.span_10{width:83.3333333333%}.span_11{width:91.6666666667%}.span_12{width:100%}.gutters .span_1{width:6.5%}.gutters .span_2{width:15%}.gutters .span_3{width:23.5%}.gutters .span_4{width:32%}.gutters .span_5{width:40.5%}.gutters .span_6{width:49%}.gutters .span_7{width:57.5%}.gutters .span_8{width:66%}.gutters .span_9{width:74.5%}.gutters .span_10{width:83%}.gutters .span_11{width:91.5%}.gutters .span_12{width:100%}}body{font-family:hiragino kaku gothic pron,Meiryo,sans-serif;font-size:.9rem;line-height:1.4rem;letter-spacing:.03rem;overflow-wrap:break-word;word-wrap:break-word}h1{font-size:1.2rem}h2{font-size:1.1rem}h3,h4,h5,h6{font-size:1rem}ul,ol{margin-left:1.8rem}li{margin:.4rem 0}pre,code{font-family:consolas,courier new,monospace;background-color:#eee;border-radius:.2rem;padding:.2rem .4rem;font-size:.9rem}pre{padding:1rem 1.4rem;max-width:100%;overflow:auto}pre code{background:inherit;font-size:inherit;color:inherit;border:0;padding:0;margin:0}blockquote{margin:2rem 0;padding:.6rem 1.2rem;border-left:4px solid #757575;font-style:italic;background-color:#eee}img{max-width:100%;height:auto;border:0;vertical-align:middle}header{padding:1.2rem 0;margin-bottom:1.2rem}article{margin-bottom:3rem}footer{margin:2rem 0;padding:.6rem 0;border-top:2px solid #757575}footer img{border-radius:2rem;-webkit-border-radius:2rem;-moz-border-radius:2rem;margin-bottom:.6rem}.article-header{border-left:4px solid #29abe2;margin:.6rem 0 1.5rem;padding:.3rem 0 .3rem .6rem}article h2{border-bottom:2px solid #757575;margin:3rem 0 1.5rem;padding-bottom:.6rem}article h3,article h4,article h5,article h6{margin:2rem 0 1.5rem}article p{margin:1.2rem 0}article img{display:block;margin:0 auto;text-align:center}.container{padding:0 1rem}.gray{color:#757575}.summary{padding-bottom:1.2rem;margin-bottom:1.2rem}.meta{font-size:.8rem}.back-to-top{margin-top:1.2rem}</style></head><body><div class=container><header><div class="row gutters"><div class=col><h1><a href=https://hacktk.net/>hacktk blog</a></h1></div></div></header><main><div class=article-header><h1>Docker で nginx を Graceful Shutdown させる</h1><div class="meta gray">2020-07-05</div></div><article><h2 id=要するに>要するに</h2><p>nginx の Dockerfile には <code>STOPSIGNAL SIGQUIT</code> を書こう。<br>でもそのうち書かなくてよくなるかもね。</p><p>2020-12-07 追記： 書かなくてよくなった。</p><h2 id=メモ書き>メモ書き</h2><p>発端は <a href=https://ubuntu.com/blog/avoiding-dropped-connections-in-nginx-containers-with-stopsignal-sigquit target=_blank rel=noopener>こちらの記事</a></p><ul><li>nginx において <a href=http://nginx.org/en/docs/control.html target=_blank rel=noopener>TERMはfast shutdown、QUITはgraceful shutdown</a>
である</li><li>nginx の公式イメージでは <a href=https://github.com/nginxinc/docker-nginx/blob/fe97d699daae7e04f916771ac520f7cf25ab2b27/mainline/buster/Dockerfile#L101 target=_blank rel=noopener>STOPSIGNAL SIGTERMを使っている</a></li><li>なので <a href=https://gist.github.com/nottrobin/79087f07efab61f013c6e7e519a96ad8#file-nginx-sigquit-dockerfile-L10 target=_blank rel=noopener>SIGQUITを使うようにする</a>
ことで graceful shutdown となる</li><li>QUIT を使えば graceful shutdown なのに、なぜそうしていないのか<ul><li>過去、 <a href=https://github.com/nginxinc/docker-nginx/issues/167 target=_blank rel=noopener>SIGQUITを使うと、Unixドメインソケットを使っている場合は正しく終了しないバグ</a>
が nginx にあったから</li><li>ただし <a href=https://trac.nginx.org/nginx/ticket/753 target=_blank rel=noopener>このバグは修正済み(2020-06-01)</a></li><li>2020-07-05 <a href=https://nginx.org/en/download.html target=_blank rel=noopener>現在のmainline最新バージョン(1.19.0)</a>
にはまだ含まれていない</li></ul></li></ul><p>↑の記事を要約しておこうと思い各リンク先を調べていたら、 <a href=https://github.com/nginxinc/docker-nginx/issues/377 target=_blank rel=noopener>デフォルトをSIGQUITにするというissue</a>
を発見した。</p><ul><li>この issue を立てたのは↑の記事の著者である</li><li>2020-06-02 に <a href=https://github.com/nginxinc/docker-nginx/issues/377#issuecomment-637422703 target=_blank rel=noopener>we can try moving to SIGQUIT.</a>
との返事をもらっている</li><li>この変更が入れば <code>STOPSIGNAL SIGQUIT</code> がデフォルトになるので追加の設定が不要になる</li></ul><p>2020-12-07 追記： <a href=https://github.com/nginxinc/docker-nginx/pull/457 target=_blank rel=noopener>変更のPRがマージされた</a>
ので、1.19.1 以降は <code>STOPSIGNAL SIGQUIT</code> がデフォルトになっている。</p></article><p class=back-to-top><a href=https://hacktk.net/>← Topへ</a></p></main><footer><div><picture>
<source type=image/webp srcset=https://hacktk.net/images/profile.webp><img src=https://hacktk.net/images/profile.png width=64 height=64 alt=hacktk></picture><p>Twitter: <a href=https://twitter.com/hacktk title=hacktk target=_blank rel=noopener>hacktk</a></p></div></footer></div></body></html>