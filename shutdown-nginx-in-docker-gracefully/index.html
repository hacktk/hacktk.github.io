<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Docker で nginx を Graceful Shutdown させる | hacktk blog</title><link rel=stylesheet href=https://hacktk.net/css/main.min.098be450fba0a98f91cb33f36f492d4b72834144a359e9568fc4ccce69ad26d5.css><link rel=icon href=https://hacktk.net/images/favicon.ico><link rel=canonical href=https://hacktk.net/shutdown-nginx-in-docker-gracefully/><link rel=alternate href=https://hacktk.net/index.xml type=application/rss+xml title="hacktk blog"><meta name=description content="Docker で nginx を動かしている場合、そのままでは Fast Shutdown になる。これを Gracefully にする方法。"><meta property="og:title" content="Docker で nginx を Graceful Shutdown させる"><meta property="og:description" content="Docker で nginx を動かしている場合、そのままでは Fast Shutdown になる。これを Gracefully にする方法。"><meta property="og:type" content="article"><meta property="og:url" content="https://hacktk.net/shutdown-nginx-in-docker-gracefully/"><meta property="og:image" content="https://hacktk.net/images/og.png"><meta property="article:published_time" content="2020-07-05T14:00:00+09:00"><meta property="article:modified_time" content="2020-07-05T14:00:00+09:00"><meta name=twitter:title content="Docker で nginx を Graceful Shutdown させる"><meta name=twitter:description content="Docker で nginx を動かしている場合、そのままでは Fast Shutdown になる。これを Gracefully にする方法。"><meta name=twitter:card content="summary"><meta name=twitter:image content="https://hacktk.net/images/og.png"></head><body><div class=container><header><div class="row gutters"><div class=col><h1><a href=https://hacktk.net/>hacktk blog</a></h1></div></div></header><main><div class=article-header><h1>Docker で nginx を Graceful Shutdown させる</h1><div class="meta gray">2020-07-05</div></div><article><h2 id=要するに>要するに</h2><p>nginx の Dockerfile には <code>STOPSIGNAL SIGQUIT</code> を書こう。<br>でもそのうち書かなくてよくなるかもね。</p><p>2020-12-07 追記： 書かなくてよくなった。</p><h2 id=メモ書き>メモ書き</h2><p>発端は <a href=https://ubuntu.com/blog/avoiding-dropped-connections-in-nginx-containers-with-stopsignal-sigquit target=_blank rel=noopener>こちらの記事</a></p><ul><li>nginx において <a href=http://nginx.org/en/docs/control.html target=_blank rel=noopener>TERMはfast shutdown、QUITはgraceful shutdown</a>
である</li><li>nginx の公式イメージでは <a href=https://github.com/nginxinc/docker-nginx/blob/fe97d699daae7e04f916771ac520f7cf25ab2b27/mainline/buster/Dockerfile#L101 target=_blank rel=noopener>STOPSIGNAL SIGTERMを使っている</a></li><li>なので <a href=https://gist.github.com/nottrobin/79087f07efab61f013c6e7e519a96ad8#file-nginx-sigquit-dockerfile-L10 target=_blank rel=noopener>SIGQUITを使うようにする</a>
ことで graceful shutdown となる</li><li>QUIT を使えば graceful shutdown なのに、なぜそうしていないのか<ul><li>過去、 <a href=https://github.com/nginxinc/docker-nginx/issues/167 target=_blank rel=noopener>SIGQUITを使うと、Unixドメインソケットを使っている場合は正しく終了しないバグ</a>
が nginx にあったから</li><li>ただし <a href=https://trac.nginx.org/nginx/ticket/753 target=_blank rel=noopener>このバグは修正済み(2020-06-01)</a></li><li>2020-07-05 <a href=https://nginx.org/en/download.html target=_blank rel=noopener>現在のmainline最新バージョン(1.19.0)</a>
にはまだ含まれていない</li></ul></li></ul><p>↑の記事を要約しておこうと思い各リンク先を調べていたら、 <a href=https://github.com/nginxinc/docker-nginx/issues/377 target=_blank rel=noopener>デフォルトをSIGQUITにするというissue</a>
を発見した。</p><ul><li>この issue を立てたのは↑の記事の著者である</li><li>2020-06-02 に <a href=https://github.com/nginxinc/docker-nginx/issues/377#issuecomment-637422703 target=_blank rel=noopener>we can try moving to SIGQUIT.</a>
との返事をもらっている</li><li>この変更が入れば <code>STOPSIGNAL SIGQUIT</code> がデフォルトになるので追加の設定が不要になる</li></ul><p>2020-12-07 追記： <a href=https://github.com/nginxinc/docker-nginx/pull/457 target=_blank rel=noopener>変更のPRがマージされた</a>
ので、1.19.1 以降は <code>STOPSIGNAL SIGQUIT</code> がデフォルトになっている。</p></article><p class=back-to-top><a href=https://hacktk.net/>← Topへ</a></p></main><footer><div><picture>
<source type=image/webp srcset=https://hacktk.net/images/profile.webp><img src=https://hacktk.net/images/profile.png width=64 height=64 alt=hacktk></picture><p>Twitter: <a href=https://twitter.com/hacktk title=hacktk target=_blank rel=noopener>hacktk</a></p></div></footer></div></body></html>