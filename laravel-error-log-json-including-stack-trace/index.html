<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Laravelで、エラーログをJSONで出力しつつStack traceを含めたい | hacktk blog</title><link rel=stylesheet href=https://hacktk.net/css/sanitize.css><link rel=stylesheet href=https://hacktk.net/css/responsive.css><link rel=stylesheet href=https://hacktk.net/css/theme.css><link rel=icon href=https://hacktk.net/images/favicon.ico><link rel=canonical href=https://hacktk.net/laravel-error-log-json-including-stack-trace/><link rel=alternate href=https://hacktk.net/index.xml type=application/rss+xml title="hacktk blog"><meta name=description content="Laravelではconfigのみでエラーログをjson出力できるが、そのままではstack traceが含まれない。これを含めるようにする方法。"><meta property="og:title" content="Laravelで、エラーログをJSONで出力しつつStack traceを含めたい"><meta property="og:description" content="Laravelではconfigのみでエラーログをjson出力できるが、そのままではstack traceが含まれない。これを含めるようにする方法。"><meta property="og:type" content="article"><meta property="og:url" content="https://hacktk.net/laravel-error-log-json-including-stack-trace/"><meta property="og:image" content="https://hacktk.net/images/profile.png"><meta property="article:published_time" content="2020-12-08T09:00:00+09:00"><meta property="article:modified_time" content="2020-12-08T09:00:00+09:00"><meta name=twitter:title content="Laravelで、エラーログをJSONで出力しつつStack traceを含めたい"><meta name=twitter:description content="Laravelではconfigのみでエラーログをjson出力できるが、そのままではstack traceが含まれない。これを含めるようにする方法。"><meta name=twitter:card content="summary"><meta name=twitter:image content="https://hacktk.net/images/profile.png"><meta name=google-site-verification content="iDFH4SmPeQqgvrQawVuuBPxcQc6A3uAYf1Qwcb8IqX8"></head><body><div class=container><header><div class="row gutters"><div class=col><h1><a href=https://hacktk.net/>hacktk blog</a></h1></div></div></header><main><div class=article-header><h1>Laravelで、エラーログをJSONで出力しつつStack traceを含めたい</h1><div class="meta gray">2020-12-08</div></div><article><h2 id=要約>要約</h2><p><code>Monolog\Formatter\JsonFormatter</code> を拡張したクラスを作り、それを使う。</p><h2 id=メモ>メモ</h2><h3 id=前提>前提</h3><ul><li>アプリケーションはLaravel</li><li>AWSのECSでCloudwatch Logsへ送信する</li><li>Log Driverはawslogs</li><li>エラーログにStack traceも含めたい</li></ul><p>この前提だと、デフォルトのLineFormatterではStack traceが行ごとに分割されてしまう。<br>なのでJSONで1行にフォーマットして出力する。</p><h3 id=方法>方法</h3><ul><li>LaravelではMonologのformatterが指定できるため、 <code>Monolog\Formatter\JsonFormatter</code> を指定すれば良い（と思っていた）</li><li>しかし、JsonFormatterはデフォルトではStack traceを含めない（Monolog 2.1.1 時点）<ul><li><a href=https://github.com/Seldaek/monolog/blob/2.1.1/src/Monolog/Formatter/JsonFormatter.php#L35 target=_blank rel=noopener>https://github.com/Seldaek/monolog/blob/2.1.1/src/Monolog/Formatter/JsonFormatter.php#L35</a></li></ul></li><li>includeStacktracesメソッドを実行して切り替えることもできなさそう（Laravel 8.17.2 時点）<ul><li><a href=https://github.com/laravel/framework/blob/v8.17.2/src/Illuminate/Log/LogManager.php#L407 target=_blank rel=noopener>https://github.com/laravel/framework/blob/v8.17.2/src/Illuminate/Log/LogManager.php#L407</a></li></ul></li><li>仕方ないのでJsonFormatterを拡張する</li></ul><p>JsonFormatterを継承し、コンストラクタでincludeStacktracesメソッドを実行するだけのクラスを作り、</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#75715e># app/Logging/Formatter/CustomJsonFormatter.php
</span><span style=color:#75715e></span>
<span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>

<span style=color:#66d9ef>declare</span>(<span style=color:#a6e22e>strict_types</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>);

<span style=color:#66d9ef>namespace</span> <span style=color:#a6e22e>App\Logging\Formatter</span>;

<span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Monolog\Formatter\JsonFormatter</span>;

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CustomJsonFormatter</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>JsonFormatter</span>
{
    <span style=color:#e6db74>/**
</span><span style=color:#e6db74>     * @param int $batchMode
</span><span style=color:#e6db74>     * @param bool $appendNewline
</span><span style=color:#e6db74>     */</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> __construct($batchMode <span style=color:#f92672>=</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>BATCH_MODE_JSON</span>, $appendNewline <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)
    {
        <span style=color:#66d9ef>parent</span><span style=color:#f92672>::</span><span style=color:#a6e22e>__construct</span>($batchMode, $appendNewline);
        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>includeStacktraces</span>();
    }
}
</code></pre></div><p>ログの設定でformatterに指定する。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#75715e># config/logging.php 抜粋
</span><span style=color:#75715e></span>
<span style=color:#e6db74>&#39;channels&#39;</span> <span style=color:#f92672>=&gt;</span> [
    <span style=color:#e6db74>&#39;stderr&#39;</span> <span style=color:#f92672>=&gt;</span> [
        <span style=color:#e6db74>&#39;driver&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;monolog&#39;</span>,
        <span style=color:#e6db74>&#39;handler&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>Monolog\Handler\StreamHandler</span><span style=color:#f92672>::</span><span style=color:#a6e22e>class</span>,
        <span style=color:#e6db74>&#39;formatter&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>App\Logging\Formatter\CustomJsonFormatter</span><span style=color:#f92672>::</span><span style=color:#a6e22e>class</span>,
        <span style=color:#e6db74>&#39;with&#39;</span> <span style=color:#f92672>=&gt;</span> [
            <span style=color:#e6db74>&#39;stream&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;php://stderr&#39;</span>,
        ],
    ],
</code></pre></div><h2 id=余談1>余談1</h2><ul><li>Symfonyでは <a href=https://github.com/symfony/monolog-bundle target=_blank rel=noopener>MonologBundle</a>
を使えば解決らしい<ul><li>いいなぁ</li></ul></li></ul><h2 id=余談2>余談2</h2><ul><li>Dockerのlog-driverオプションを使う方法もある<ul><li><a href=https://docs.docker.com/config/containers/logging/awslogs/#awslogs-datetime-format target=_blank rel=noopener>https://docs.docker.com/config/containers/logging/awslogs/#awslogs-datetime-format</a></li><li><a href=https://docs.docker.com/config/containers/logging/awslogs/#awslogs-multiline-pattern target=_blank rel=noopener>https://docs.docker.com/config/containers/logging/awslogs/#awslogs-multiline-pattern</a></li></ul></li><li>が、どちらも失敗することがあった<ul><li>Stack traceが50行あったとして、<ol><li>33行め〜50行め</li><li>4行め〜32行め</li><li>1行め〜3行め</li></ol></li><li>のように出力されることがある</li></ul></li><li>たまたまフォーマットに一致した行が出てきたわけではない</li><li>awslogsの文字数上限に引っかかっているわけでもはない（謎）</li></ul></article><p class=back-to-top><a href=https://hacktk.net/>← Topへ</a></p></main><footer><div><picture>
<source type=image/webp srcset=https://hacktk.net/images/profile.webp><img src=https://hacktk.net/images/profile.png width=64 height=64 alt=hacktk></picture><p>Twitter: <a href=https://twitter.com/hacktk title=hacktk target=_blank rel=noopener>hacktk</a></p></div></footer></div></body></html>